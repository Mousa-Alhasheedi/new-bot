from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, CallbackContext, filters
import yt_dlp
import logging
import os

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø¬Ù„ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)
logger = logging.getLogger(__name__)

# Ù…Ø¹Ø±Ù Ø§Ù„Ù‚Ù†Ø§Ø© (Ø¶Ø¹ Ù‡Ù†Ø§ Ù…Ø¹Ø±Ù Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ)
CHANNEL_USERNAME = "@MediaDownloader22"

# Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©
async def check_subscription(update: Update, context: CallbackContext) -> bool:
    user_id = update.message.from_user.id
    try:
        user_status = await context.bot.get_chat_member(chat_id=CHANNEL_USERNAME, user_id=user_id)
        if user_status.status in ['member', 'administrator', 'creator']:
            return True
        else:
            return False
    except Exception as e:
        logger.error(f"Error checking subscription: {e}")
        return False

# Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ·Ù„Ø¨ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
async def request_subscription(update: Update) -> None:
    await update.message.reply_text(
        f"âŒ ÙŠØ¬Ø¨ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ù‚Ù†Ø§ØªÙ†Ø§ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª: {CHANNEL_USERNAME}\n\n"
        "ğŸ”” Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰."
    )

# Ø¯Ø§Ù„Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ø¨ÙˆØª
async def start(update: Update, context: CallbackContext) -> None:
    logger.info("ØªÙ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø£Ù…Ø± /start")
    if not await check_subscription(update, context):
        await request_subscription(update)
        return

    await update.message.reply_text(
        "ğŸ‘‹ Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·!\n\n"
        "ğŸ¥ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù†:\n"
        "- ÙŠÙˆØªÙŠÙˆØ¨\n"
        "- Ø¥Ù†Ø³ØªØ¬Ø±Ø§Ù…\n"
        "- ØªÙŠÙƒ ØªÙˆÙƒ\n"
        "- ÙÙŠØ³Ø¨ÙˆÙƒ\n\n"
        "ğŸ“© Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ Ø§Ù„ØµÙˆØª Ù„ØªØ­Ù…ÙŠÙ„Ù‡.\n"
        "ğŸ“– Ø£Ø±Ø³Ù„ /help Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª."
    )

# Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
async def help_command(update: Update, context: CallbackContext) -> None:
    logger.info("ØªÙ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø£Ù…Ø± /help")
    if not await check_subscription(update, context):
        await request_subscription(update)
        return

    await update.message.reply_text(
        "ğŸ“š **ÙƒÙŠÙÙŠØ© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª**:\n\n"
        "1ï¸âƒ£ Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø·Ù‹Ø§ Ù…Ù† Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„ØªØ§Ù„ÙŠØ©:\n"
        "- ÙŠÙˆØªÙŠÙˆØ¨\n"
        "- Ø¥Ù†Ø³ØªØ¬Ø±Ø§Ù…\n"
        "- ØªÙŠÙƒ ØªÙˆÙƒ\n"
        "- ÙÙŠØ³Ø¨ÙˆÙƒ\n\n"
        "2ï¸âƒ£ Ø³Ø£Ù‚ÙˆÙ… Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ³Ø§Ø¦Ø· ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹!\n\n"
        "ğŸ’¡ **Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©**:\n"
        "/start - Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©\n"
        "/help - Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©"
    )

# Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
async def handle_link(update: Update, context: CallbackContext) -> None:
    if not await check_subscription(update, context):
        await request_subscription(update)
        return

    url = update.message.text.strip()
    logger.info(f"ØªÙ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø·: {url}")
    await update.message.reply_text("ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„...")

    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø±Ø§Ø¨Ø·
    if any(site in url for site in ['youtube.com', 'youtu.be', 'instagram.com', 'tiktok.com', 'facebook.com']):
        try:
            download_path = "downloads"
            os.makedirs(download_path, exist_ok=True)

            ydl_opts = {
                'format': 'best',
                'outtmpl': f'{download_path}/%(title)s.%(ext)s',
                'noplaylist': True,
            }

            with yt_dlp.YoutubeDL(ydl_opts) as ydl:
                info = ydl.extract_info(url, download=True)
                file_path = ydl.prepare_filename(info)

            with open(file_path, 'rb') as file:
                await update.message.reply_document(file)
                await update.message.reply_text("âœ… ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!")

            # Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø­Ø©
            os.remove(file_path)

        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·: {e}")
            await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ùˆ Ù…Ù† Ø£Ù† Ø§Ù„ÙˆØ³Ø§Ø¦Ø· Ù…ØªØ§Ø­Ø©.")
    else:
        await update.message.reply_text("âš ï¸ Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ù…Ù† ÙŠÙˆØªÙŠÙˆØ¨ØŒ Ø¥Ù†Ø³ØªØ¬Ø±Ø§Ù…ØŒ ØªÙŠÙƒ ØªÙˆÙƒ Ø£Ùˆ ÙÙŠØ³Ø¨ÙˆÙƒ.")

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙˆØª
def main():
    TOKEN = "7822645922:AAEcpF0JoN0UGSzZ-5VX8h8AI9c2HPloWQw"  # Ø¶Ø¹ ØªÙˆÙƒÙ† Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ù†Ø§
    application = Application.builder().token(TOKEN).build()

    # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ÙˆØ§Ù…Ø± ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_link))

    logger.info("ğŸ¤– Ø§Ù„Ø¨ÙˆØª Ø¨Ø¯Ø£ ÙÙŠ Ø§Ù„Ø¹Ù…Ù„!")
    application.run_polling()

if __name__ == '__main__':
    main()
